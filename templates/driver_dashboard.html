{% extends "base.html" %}
{% block title %}Driver Dashboard{% endblock %}
{% block content %}

<div class="card" style="margin-top: 2rem;">
    <h2>Driver Dashboard</h2>

    {% if driver %}
        <p><strong>Name:</strong> {{ driver.name }}</p>
        <p><strong>License Number:</strong> {{ driver.license_number }}</p>
        <p><strong>Vehicle:</strong> {{ driver.vehicle_info }}</p>
        <p><strong>Verification Status:</strong> {{ driver.verification_status }}</p>
        <p><strong>Status:</strong>
            {% if driver.is_online %}
                <span style="color: green; font-weight: bold;">Online</span>
            {% else %}
                <span style="color: gray; font-weight: bold;">Offline</span>
            {% endif %}
        </p>
    {% else %}
        <p>Driver information not found.</p>
    {% endif %}
</div>

<div class="card ride-requests-card" style="margin-top: 2rem;">
    <h3>Ride Requests</h3>

    {% if ride_requests and ride_requests|length > 0 %}
        {% for ride in ride_requests %}
            <div class="ride-item" style="padding:1rem; border:1px solid #ddd; margin-bottom:1rem; border-radius:10px;">
                <p><strong>Ride #{{ ride.id }}</strong></p>
                <p><strong>Pickup:</strong> {{ ride.pickup_address }}</p>
                <p><strong>Dropoff:</strong> {{ ride.dropoff_address }}</p>

                {% if ride.estimated_time_minutes %}
                    <p><strong>Estimated Time:</strong> ~{{ ride.estimated_time_minutes }} min</p>
                {% endif %}

                {# Small map preview for pickup location if we have coords #}
                {% if ride.pickup_lat and ride.pickup_lng %}
                <div id="ride-map-{{ ride.id }}"
                     class="ride-map"
                     data-lat="{{ ride.pickup_lat }}"
                     data-lng="{{ ride.pickup_lng }}"
                     style="height: 200px; border-radius: 10px; margin-top: 0.5rem; border: 1px solid #ccc;">
                </div>
                {% endif %}

                <div style="margin-top:0.75rem;">
                    <form action="{{ url_for('driver_accept_ride', ride_id=ride.id) }}" method="POST" style="display:inline-block;">
                        <button class="btn btn-success btn-sm" type="submit">Accept</button>
                    </form>

                    <form action="{{ url_for('driver_reject_ride', ride_id=ride.id) }}" method="POST" style="display:inline-block; margin-left:0.5rem;">
                        <button class="btn btn-danger btn-sm" type="submit">Reject</button>
                    </form>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>No ride requests at the moment.</p>
    {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // For each ride that has coords, create its own Leaflet map
    var mapContainers = document.querySelectorAll('.ride-map');

    mapContainers.forEach(function (el) {
        var lat = parseFloat(el.dataset.lat);
        var lng = parseFloat(el.dataset.lng);

        if (isNaN(lat) || isNaN(lng)) {
            return;
        }

        var map = L.map(el).setView([lat, lng], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([lat, lng]).addTo(map);
    });
});
</script>
{% endblock %}
