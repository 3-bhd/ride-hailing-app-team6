{% extends "base.html" %}

{% block title %}Request a Ride | U-Ride{% endblock %}

{% block content %}
<div class="card passenger-dashboard">
    <div class="dashboard-header">
        <h2 class="card-title">Request a Ride</h2>
        {% if passenger %}
        <div class="passenger-info">
            <span class="avatar">{{ passenger.name[0]|upper }}</span>
            <span>{{ passenger.name }}</span>
        </div>
        {% endif %}
    </div>

    <div class="form-steps">
        <div class="step active">
            <div class="step-number">1</div>
            <div class="step-label">Where to?</div>
        </div>
        <div class="step">
            <div class="step-number">2</div>
            <div class="step-label">Fare estimate</div>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <div class="step-label">Confirm</div>
        </div>
    </div>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="flash-messages">
        {% for message in messages %}
        <div class="flash-message">
            <span class="flash-icon">‚úì</span>
            <span class="flash-text">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('passenger_request_ride') }}" class="ride-form">
        <div class="address-input-group">
            <!-- PICKUP ROW -->
            <div class="input-row">
                <div class="input-icon">‚óè</div>
                <div class="input-wrapper">
                    <label for="pickup_address" class="input-label">Pickup location</label>
                    <input id="pickup_address" type="text" name="pickup_address"
                           class="address-input"
                           placeholder="Enter pickup address"
                           required autocomplete="off">
                    <!-- Autocomplete suggestions -->
                    <div id="pickup_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <input type="hidden" id="pickup_lat" name="pickup_lat">
                <input type="hidden" id="pickup_lng" name="pickup_lng">
            </div>

            <div class="input-divider">
                <div class="divider-line"></div>
            </div>

            <!-- DROPOFF ROW -->
            <div class="input-row">
                <div class="input-icon">üìç</div>
                <div class="input-wrapper">
                    <label for="dropoff_address" class="input-label">Destination</label>
                    <input id="dropoff_address" type="text" name="dropoff_address"
                           class="address-input"
                           placeholder="Where are you going?"
                           required autocomplete="off">
                    <!-- Autocomplete suggestions -->
                    <div id="dropoff_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <input type="hidden" id="dropoff_lat" name="dropoff_lat">
                <input type="hidden" id="dropoff_lng" name="dropoff_lng">
            </div>
        </div>

        <div class="notes-section">
            <label for="notes" class="notes-label">Add a note for your driver (optional)</label>
            <textarea id="notes" name="notes" class="notes-textarea"
                      placeholder="e.g., I have 2 bags, waiting at the main entrance..."
                      rows="2"></textarea>
        </div>

        <!-- MAP SECTION: PREVIEW ONLY -->
        <div class="card" style="margin-top: 1.5rem;">
            <h3 class="section-title">Locations on map (preview)</h3>
            <p class="map-hint">
                Type your pickup and destination above and select from the suggestions.
                The map will show your chosen locations. You <strong>cannot set locations by clicking the map</strong>.
            </p>

            <div id="ride-map"
                 style="height: 300px; border-radius: 12px; margin-top: 0.75rem;">
            </div>
        </div>

        <button type="submit" class="btn-request-ride" style="margin-top: 1.5rem;">
            <span class="btn-text">Get fare estimate</span>
            <span class="btn-arrow">‚Üí</span>
        </button>
    </form>

    <div class="recent-trips">
        <h3 class="section-title">Recent trips</h3>

        {% if recent_rides and recent_rides|length > 0 %}
            <div class="trip-list">
                {% for r in recent_rides %}
                    <div class="trip-item">
                        <div class="trip-main">
                            <div class="trip-route">
                                <div class="trip-status-badge {{ 'completed' if r.status == 'completed' else 'cancelled' }}">
                                    {{ r.status|capitalize }}
                                </div>
                                <div class="trip-addresses">
                                    <div class="trip-pickup">{{ r.pickup_address }}</div>
                                    <div class="trip-arrow">‚Üí</div>
                                    <div class="trip-dropoff">{{ r.dropoff_address }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="trip-meta">
                            {% if r.driver_name %}
                                <span class="trip-driver">Driver: {{ r.driver_name }}</span>
                            {% endif %}
                            {% if r.created_at %}
                                <span class="trip-time">On: {{ r.created_at }}</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üöó</div>
                <p class="empty-text">No recent trips yet</p>
                <p class="empty-subtext">Your ride history will appear here</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ============== AUTOCOMPLETE USING OPENSTREETMAP (NOMINATIM) ==============
function setupAutocomplete(inputId, suggestionsId, latId, lngId, markerMode) {
    const input = document.getElementById(inputId);
    const box = document.getElementById(suggestionsId);
    const latInput = document.getElementById(latId);
    const lngInput = document.getElementById(lngId);

    let timeoutId = null;

    input.addEventListener('input', function () {
        const q = input.value.trim();
        // Clear coords if user changes text
        latInput.value = '';
        lngInput.value = '';

        if (q.length < 3) {
            box.innerHTML = '';
            box.style.display = 'none';
            return;
        }

        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            fetch("https://nominatim.openstreetmap.org/search?format=json&limit=5&q=" + encodeURIComponent(q))
                .then(res => res.json())
                .then(results => {
                    box.innerHTML = '';
                    if (!results || results.length === 0) {
                        box.style.display = 'none';
                        return;
                    }
                    results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.textContent = item.display_name;
                        div.addEventListener('click', () => {
                            input.value = item.display_name;
                            latInput.value = item.lat;
                            lngInput.value = item.lon;
                            box.innerHTML = '';
                            box.style.display = 'none';

                            const lat = parseFloat(item.lat);
                            const lng = parseFloat(item.lon);
                            if (!isNaN(lat) && !isNaN(lng)) {
                                setMarker(markerMode, lat, lng);
                            }
                        });
                        box.appendChild(div);
                    });
                    box.style.display = 'block';
                })
                .catch(err => {
                    console.error('Nominatim error', err);
                    box.innerHTML = '';
                    box.style.display = 'none';
                });
        }, 400);
    });

    // Close suggestions if clicking outside
    document.addEventListener('click', function (e) {
        if (!box.contains(e.target) && e.target !== input) {
            box.innerHTML = '';
            box.style.display = 'none';
        }
    });
}

// ============== MAP (LEAFLET PREVIEW ONLY) ==============
let map, pickupMarker, dropoffMarker;

function setMarker(mode, lat, lng) {
    if (!map) return;
    const pos = [lat, lng];

    if (mode === 'pickup') {
        if (pickupMarker) map.removeLayer(pickupMarker);
        pickupMarker = L.marker(pos).addTo(map);
        document.getElementById('pickup_lat').value = lat.toFixed(6);
        document.getElementById('pickup_lng').value = lng.toFixed(6);
    } else {
        if (dropoffMarker) map.removeLayer(dropoffMarker);
        dropoffMarker = L.marker(pos).addTo(map);
        document.getElementById('dropoff_lat').value = lat.toFixed(6);
        document.getElementById('dropoff_lng').value = lng.toFixed(6);
    }

    map.setView(pos, 14);
}

document.addEventListener('DOMContentLoaded', function () {
    // Map init (center on Cairo)
    const initialLat = 30.0444;
    const initialLng = 31.2357;

    map = L.map('ride-map').setView([initialLat, initialLng], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // NO map.on('click') ‚Äì map is preview only now

    // Autocomplete setup (typing is the ONLY way to set locations)
    setupAutocomplete('pickup_address', 'pickup_suggestions', 'pickup_lat', 'pickup_lng', 'pickup');
    setupAutocomplete('dropoff_address', 'dropoff_suggestions', 'dropoff_lat', 'dropoff_lng', 'dropoff');
});
</script>
{% endblock %}
